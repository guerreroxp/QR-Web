<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Control de Acceso por QR</title>
  <style>
    :root {
      --ok: #16a34a;
      --warn: #f59e0b;
      --bad: #dc2626;
      --fg: #0f172a;
      --muted: #64748b;
      --bg: #f8fafc;
      --card: #ffffff;
      --border: #e2e8f0;
    }
    html, body { height: 100%; background: var(--bg); color: var(--fg); margin: 0; }
    body { font-family: system-ui, sans-serif; }
    .wrap { max-width: 900px; margin: 0 auto; padding: 16px; }
    h1 { font-size: 1.25rem; margin-bottom: 12px; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 12px; }
    .row { display: grid; gap: 12px; }
    @media (min-width: 720px) { .row { grid-template-columns: 1.3fr .7fr; } }
    .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }
    select, input[type="file"], button {
      border: 1px solid var(--border); border-radius: 10px; padding: 10px 12px;
      font-size: 16px; background: white;
    }
    button { cursor: pointer; }
    button.primary { background: #0ea5e9; color: white; border: none; }
    button.secondary { background: #f1f5f9; }
    .status { margin-top: 10px; border-radius: 12px; padding: 12px; font-weight: 600; }
    .ok { background: #dcfce7; color: var(--ok); }
    .warn { background: #fef9c3; color: #a16207; }
    .bad { background: #fee2e2; color: var(--bad); }
    .muted { color: var(--muted); font-weight: 500; }
    #reader { width: 100%; min-height: 320px; border-radius: 12px; overflow: hidden; }
    .hint { font-size: .9rem; color: var(--muted); }
    table { width: 100%; border-collapse: collapse; font-size: .95rem; }
    th, td { border-bottom: 1px solid var(--border); padding: 10px 8px; text-align: left; }
    th { background: #f8fafc; position: sticky; top: 0; }
    .tag { font-size: .8rem; padding: 2px 8px; border-radius: 999px; font-weight: 700; display: inline-block; }
    .tag.ok { background: #dcfce7; color: var(--ok); }
    .tag.warn { background: #fef9c3; color: #a16207; }
    .tag.bad { background: #fee2e2; color: var(--bad); }
    .flex { display:flex; align-items:center; gap:6px; flex-wrap: wrap; }
    .small { font-size: .85rem; color: var(--muted); }
  </style>
  <script src="https://unpkg.com/html5-qrcode" defer></script>
</head>
<body>
<div class="wrap">
  <h1>Control de Acceso por QR</h1>
  <div class="row">
    <div class="card">
      <div class="flex" style="justify-content:space-between;">
        <div class="small">1) Permitir c√°mara ‚Ä¢ 2) Selecciona c√°mara ‚Ä¢ 3) Carga listado ‚Ä¢ 4) Inicia escaneo</div>
      </div>

      <!-- Bot√≥n para habilitar la c√°mara -->
      <div style="margin: 10px 0;">
        <button id="btnPermisoCam" class="primary">üì∑ Habilitar c√°mara</button>
      </div>

      <div class="controls">
        <select id="cameraSelect" title="C√°mara"></select>
        <div class="flex" style="gap:8px;">
          <button id="btnStart" class="primary">Iniciar</button>
          <button id="btnStop" class="secondary">Detener</button>
        </div>
        <button id="btnRecargar" class="secondary">Recargar listado.txt</button>
        <input id="fileTxt" type="file" accept=".txt" />
      </div>

      <div id="status" class="status muted">Esperando‚Ä¶</div>
      <div id="reader" style="margin-top:10px;"></div>
      <div class="hint">Usa la c√°mara trasera para mejor enfoque.</div>
    </div>

    <div class="card">
      <div class="flex" style="justify-content:space-between; margin-bottom:8px;">
        <div>
          <div><strong>Resumen</strong></div>
          <div class="small" id="resumenInfo">C√≥digos cargados: 0 ‚Ä¢ Pasaron: 0</div>
        </div>
        <div class="flex">
          <button id="btnExport" class="secondary">Exportar CSV</button>
          <button id="btnReset" class="secondary">Reiniciar</button>
        </div>
      </div>
      <div style="max-height: 360px; overflow: auto; border:1px solid var(--border); border-radius:10px;">
        <table>
          <thead><tr><th>Hora</th><th>C√≥digo</th><th>Estado</th><th>Detalle</th></tr></thead>
          <tbody id="logBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  let whitelist = new Set();
  const PASSES_KEY = "qr_passes";
  let passes = loadPasses();
  let html5Qr, scanning = false;

  const el = id => document.getElementById(id);
  const nowIso = () => new Date().toISOString();
  const formatTime = iso => new Date(iso).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  const normalize = s => (s || "").toString().trim();

  function loadPasses(){ try { return JSON.parse(localStorage.getItem(PASSES_KEY)) || {}; } catch { return {}; } }
  function savePasses(){ localStorage.setItem(PASSES_KEY, JSON.stringify(passes)); }
  function setStatus(kind, msg){ const box = el("status"); box.className = "status " + (kind || "muted"); box.textContent = msg; }
  function updateResumen(){ el("resumenInfo").textContent = `C√≥digos cargados: ${whitelist.size} ‚Ä¢ Pasaron: ${Object.keys(passes).length}`; }
  function appendLog({whenIso, code, state, detail}){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${formatTime(whenIso)}</td><td>${code}</td>
      <td><span class="tag ${state}">${state==="ok"?"OK":state==="warn"?"Repetido":"No existe"}</span></td>
      <td>${detail||""}</td>`;
    const body = el("logBody");
    body.insertBefore(tr, body.firstChild);
  }

  async function loadListadoTxtAuto(){
    try {
      const res = await fetch("listado.txt", { cache: "no-store" });
      if (!res.ok) throw new Error();
      const text = await res.text();
      whitelist = new Set(text.split(/\r?\n/).map(l=>normalize(l)).filter(Boolean));
      setStatus("ok", `Listado cargado (${whitelist.size} c√≥digos).`);
      updateResumen();
    } catch {
      setStatus("warn", "No se pudo cargar listado.txt. Sube el archivo manualmente.");
    }
  }

  async function startScan(){
    if (scanning) return;
    const camId = el("cameraSelect").value;
    if (!camId) return setStatus("warn", "Selecciona una c√°mara.");
    html5Qr = new Html5Qrcode("reader");
    try {
      await html5Qr.start({ deviceId: { exact: camId } }, { fps: 10, qrbox: 250 }, onScanSuccess);
      scanning = true;
      setStatus("muted", "Escaneando‚Ä¶");
    } catch (err) {
      setStatus("bad", "No se pudo iniciar: " + err);
    }
  }

  async function stopScan(){
    if (html5Qr && scanning) { await html5Qr.stop(); await html5Qr.clear(); }
    scanning = false;
    setStatus("muted", "Escaneo detenido.");
  }

  function onScanSuccess(decodedText){
    const code = normalize(decodedText);
    const whenIso = nowIso();
    const firstPassIso = passes[code];
    if (!whitelist.size) return setStatus("warn", "Carga el listado primero.");
    if (!whitelist.has(code)) {
      setStatus("bad", "‚ùå C√≥digo NO existe.");
      appendLog({whenIso, code, state:"bad", detail:"No autorizado"});
      return;
    }
    if (!firstPassIso) {
      passes[code] = whenIso; savePasses();
      setStatus("ok", `‚úÖ OK, puede pasar. Hora: ${formatTime(whenIso)}`);
      appendLog({whenIso, code, state:"ok", detail:"Primera pasada"});
    } else {
      setStatus("warn", `üü° Ya pas√≥ a las ${formatTime(firstPassIso)}`);
      appendLog({whenIso, code, state:"warn", detail:`Primera: ${formatTime(firstPassIso)}`});
    }
    updateResumen();
  }

  async function fillCameras(){
    const sel = el("cameraSelect"); sel.innerHTML = "";
    const devices = await navigator.mediaDevices.enumerateDevices();
    const cams = devices.filter(d => d.kind === "videoinput");
    cams.sort((a,b)=>(/back|trase|rear/.test((a.label||"").toLowerCase())?-1:0) - (/back|trase|rear/.test((b.label||"").toLowerCase())?-1:0));
    cams.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c.deviceId; opt.textContent = c.label || `C√°mara ${sel.length+1}`;
      sel.appendChild(opt);
    });
  }

  // Solicitud de permiso
  el("btnPermisoCam").addEventListener("click", async ()=>{
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      stream.getTracks().forEach(track => track.stop());
      setStatus("ok", "‚úÖ Permiso concedido. Ahora selecciona la c√°mara y carga el listado.");
      el("btnPermisoCam").style.display = "none";
      await fillCameras();
    } catch (err) {
      setStatus("bad", "‚ùå Permiso de c√°mara denegado.");
    }
  });

  el("btnStart").addEventListener("click", startScan);
  el("btnStop").addEventListener("click", stopScan);
  el("btnRecargar").addEventListener("click", loadListadoTxtAuto);
  el("btnExport").addEventListener("click", ()=>{
    const rows = [["Hora","C√≥digo","Estado","Detalle"]];
    document.querySelectorAll("#logBody tr").forEach(tr=>{
      rows.push(Array.from(tr.children).map(td=>td.textContent));
    });
    const csv = rows.map(r => r.map(v=>`"${v}"`).join(",")).join("\n");
    const blob = new Blob([csv], {type:"text/csv"}), url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href = url; a.download = "historial.csv"; a.click();
  });
  el("btnReset").addEventListener("click", ()=>{ passes = {}; savePasses(); updateResumen(); setStatus("muted", "Registro reiniciado."); });
  el("fileTxt").addEventListener("change", async e=>{
    const file = e.target.files[0]; if (!file) return;
    const text = await file.text();
    whitelist = new Set(text.split(/\r?\n/).map(l=>normalize(l)).filter(Boolean));
    setStatus("ok", `Listado cargado manual (${whitelist.size} c√≥digos).`); updateResumen();
  });

  (async function init(){ updateResumen(); await loadListadoTxtAuto(); })();
})();
</script>
</body>
</html>
