  <!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lector QR con Permiso de C√°mara</title>
<style>
  body {
    font-family: Arial, sans-serif;
    text-align: center;
    margin: 0;
    padding: 20px;
    background-color: #f5f5f5;
  }
  #btnPermisoCam, #btnIniciarQR {
    background-color: #4CAF50;
    border: none;
    color: white;
    padding: 12px 20px;
    text-align: center;
    font-size: 16px;
    margin: 10px;
    cursor: pointer;
    border-radius: 5px;
  }
  #btnPermisoCam:hover, #btnIniciarQR:hover {
    background-color: #45a049;
  }
  video {
    width: 100%;
    max-width: 400px;
    margin-top: 15px;
    border: 2px solid #ccc;
    border-radius: 8px;
  }
</style>
</head>
<body>

<h2>üì∑ Lector QR con Solicitud de Permiso</h2>

<!-- Bot√≥n para pedir permiso de c√°mara -->
<div>
  <button id="btnPermisoCam">üì∑ Habilitar c√°mara</button>
</div>

<!-- Bot√≥n para iniciar lector QR -->
<div>
  <button id="btnIniciarQR" disabled>‚ñ∂ Iniciar lector QR</button>
</div>

<!-- Vista de la c√°mara -->
<video id="video" autoplay playsinline></video>

<!-- Resultado -->
<p><strong>Resultado:</strong> <span id="resultado">-</span></p>

<!-- Librer√≠a para leer QR -->
<script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>

<script>
let streamActivo = null;
let escaneoActivo = false;

async function checkCamPermission() {
  try {
    const result = await navigator.permissions.query({ name: 'camera' });
    if (result.state === "granted") {
      document.getElementById("btnPermisoCam").style.display = "none";
      document.getElementById("btnIniciarQR").disabled = false;
    } else if (result.state === "denied") {
      alert("‚ö†Ô∏è La c√°mara est√° bloqueada. Ve a Ajustes del sitio en tu navegador y habil√≠tala.");
    }
  } catch (e) {
    console.log("No se pudo verificar permisos:", e);
  }
}

document.getElementById("btnPermisoCam").addEventListener("click", async () => {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    stream.getTracks().forEach(track => track.stop()); // Cierra c√°mara
    alert("‚úÖ Permiso concedido. Ahora puedes iniciar el lector QR.");
    document.getElementById("btnPermisoCam").style.display = "none";
    document.getElementById("btnIniciarQR").disabled = false;
  } catch (err) {
    alert("‚ùå No se pudo acceder a la c√°mara: " + err.message);
  }
});

document.getElementById("btnIniciarQR").addEventListener("click", async () => {
  if (escaneoActivo) {
    detenerEscaneo();
    document.getElementById("btnIniciarQR").textContent = "‚ñ∂ Iniciar lector QR";
    return;
  }
  try {
    streamActivo = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
    const video = document.getElementById("video");
    video.srcObject = streamActivo;
    escaneoActivo = true;
    document.getElementById("btnIniciarQR").textContent = "‚èπ Detener lector QR";
    escanearQR();
  } catch (err) {
    alert("‚ùå Error al iniciar c√°mara: " + err.message);
  }
});

function detenerEscaneo() {
  if (streamActivo) {
    streamActivo.getTracks().forEach(track => track.stop());
    streamActivo = null;
  }
  escaneoActivo = false;
}

function escanearQR() {
  if (!escaneoActivo) return;
  const video = document.getElementById("video");
  const canvas = document.createElement("canvas");
  const context = canvas.getContext("2d");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  context.drawImage(video, 0, 0, canvas.width, canvas.height);
  const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
  const code = jsQR(imageData.data, canvas.width, canvas.height);
  if (code) {
    document.getElementById("resultado").textContent = code.data;
    detenerEscaneo();
    document.getElementById("btnIniciarQR").textContent = "‚ñ∂ Iniciar lector QR";
  } else {
    requestAnimationFrame(escanearQR);
  }
}

checkCamPermission();
</script>

</body>
</html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Control de Acceso por QR</title>
  <style>
    :root {
      --ok: #16a34a;       /* verde */
      --warn: #f59e0b;     /* amarillo */
      --bad: #dc2626;      /* rojo */
      --fg: #0f172a;       /* texto */
      --muted: #64748b;    /* gris */
      --bg: #f8fafc;       /* fondo */
      --card: #ffffff;
      --border: #e2e8f0;
    }
    html, body { height: 100%; background: var(--bg); color: var(--fg); }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; }
    .wrap { max-width: 900px; margin: 0 auto; padding: 16px; }
    h1 { font-size: 1.25rem; margin: 0 0 12px; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 12px; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    .row { display: grid; gap: 12px; }
    @media (min-width: 720px) { .row { grid-template-columns: 1.3fr .7fr; } }

    /* Controles */
    .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 8px 0 0; }
    .controls > * { width: 100%; }
    select, input[type="file"], button {
      border: 1px solid var(--border); border-radius: 10px; padding: 10px 12px;
      font-size: 16px; background: white;
    }
    button { cursor: pointer; }
    button.primary { background: #0ea5e9; color: white; border: none; }
    button.secondary { background: #f1f5f9; }
    button:active { transform: translateY(1px); }

    /* Estado */
    .status { margin-top: 10px; border-radius: 12px; padding: 12px; font-weight: 600; }
    .ok    { background: #dcfce7; color: var(--ok); border: 1px solid #bbf7d0; }
    .warn  { background: #fef9c3; color: #a16207; border: 1px solid #fde68a; }
    .bad   { background: #fee2e2; color: var(--bad); border: 1px solid #fecaca; }
    .muted { color: var(--muted); font-weight: 500; }

    /* QR */
    #reader { width: 100%; min-height: 320px; border-radius: 12px; overflow: hidden; }
    .hint { font-size: .9rem; color: var(--muted); }

    /* Tabla historial */
    table { width: 100%; border-collapse: collapse; font-size: .95rem; }
    th, td { border-bottom: 1px solid var(--border); padding: 10px 8px; text-align: left; }
    th { background: #f8fafc; font-weight: 700; position: sticky; top: 0; z-index: 1; }
    .tag { font-size: .8rem; padding: 2px 8px; border-radius: 999px; font-weight: 700; display: inline-block; }
    .tag.ok { background: #dcfce7; color: var(--ok); border: 1px solid #bbf7d0; }
    .tag.warn { background: #fef9c3; color: #a16207; border: 1px solid #fde68a; }
    .tag.bad { background: #fee2e2; color: var(--bad); border: 1px solid #fecaca; }
    .flex { display:flex; align-items:center; gap:6px; flex-wrap: wrap; }
    .small { font-size: .85rem; color: var(--muted); }
  </style>
  <!-- Librer√≠a lector QR -->
  <script src="https://unpkg.com/html5-qrcode" defer></script>
</head>
<body>
  <div class="wrap">
    <h1>Control de Acceso por QR</h1>
    <div class="row">
      <!-- Columna Izquierda: Lector -->
      <div class="card">
        <div class="flex" style="justify-content:space-between;">
          <div class="small">1) Selecciona c√°mara ‚Ä¢ 2) Carga listado ‚Ä¢ 3) Inicia escaneo</div>
        </div>
        <div class="controls">
          <select id="cameraSelect" title="C√°mara"></select>
          <div class="flex" style="gap:8px;">
            <button id="btnStart" class="primary">Iniciar</button>
            <button id="btnStop"  class="secondary">Detener</button>
          </div>
          <button id="btnRecargar" class="secondary">Recargar listado.txt</button>
          <input id="fileTxt" type="file" accept=".txt" />
        </div>

        <div id="status" class="status muted">Esperando‚Ä¶ Carga el listado y presiona ‚ÄúIniciar‚Äù.</div>

        <div id="reader" style="margin-top:10px;"></div>
        <div class="hint">Consejo: usa la c√°mara trasera para mejor enfoque.</div>
      </div>

      <!-- Columna Derecha: Resumen -->
      <div class="card">
        <div class="flex" style="justify-content:space-between; margin-bottom:8px;">
          <div>
            <div><strong>Resumen</strong></div>
            <div class="small" id="resumenInfo">C√≥digos cargados: 0 ‚Ä¢ Pasaron: 0</div>
          </div>
          <div class="flex">
            <button id="btnExport" class="secondary">Exportar historial (CSV)</button>
            <button id="btnReset" class="secondary">Reiniciar ‚Äúya pas√≥‚Äù</button>
          </div>
        </div>
        <div style="max-height: 360px; overflow: auto; border:1px solid var(--border); border-radius:10px;">
          <table>
            <thead>
              <tr>
                <th>Hora</th>
                <th>C√≥digo</th>
                <th>Estado</th>
                <th>Detalle</th>
              </tr>
            </thead>
            <tbody id="logBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  // --- Estado en memoria
  let whitelist = new Set();               // c√≥digos permitidos
  const PASSES_KEY = "qr_passes";          // { code: "2025-08-13T12:34:56.789Z", ... }
  let passes = loadPasses();               // historial de primeras pasadas
  let html5Qr;                             // instancia del lector
  let scanning = false;

  // --- Utilidades
  const el = id => document.getElementById(id);
  const nowIso = () => new Date().toISOString();
  const formatTime = iso => {
    const d = iso ? new Date(iso) : new Date();
    // Hora local en formato HH:MM:SS
    return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  };
  const normalize = s => (s || "").toString().trim();

  function loadPasses(){
    try { return JSON.parse(localStorage.getItem(PASSES_KEY)) || {}; }
    catch { return {}; }
  }
  function savePasses(){ localStorage.setItem(PASSES_KEY, JSON.stringify(passes)); }

  function setStatus(kind, msg){
    const box = el("status");
    box.className = "status " + (kind || "muted");
    box.textContent = msg;
  }

  function updateResumen(){
    el("resumenInfo").textContent = `C√≥digos cargados: ${whitelist.size} ‚Ä¢ Pasaron: ${Object.keys(passes).length}`;
  }

  function appendLog({whenIso, code, state, detail}){
    const tr = document.createElement("tr");
    const tdWhen = document.createElement("td");
    const tdCode = document.createElement("td");
    const tdState = document.createElement("td");
    const tdDetail = document.createElement("td");

    tdWhen.textContent = formatTime(whenIso);
    tdCode.textContent = code;
    tdState.innerHTML = `<span class="tag ${state}">${state === "ok" ? "OK" : state === "warn" ? "Repetido" : "No existe"}</span>`;
    tdDetail.textContent = detail || "";

    // Insertar arriba
    const body = el("logBody");
    if (body.firstChild) body.insertBefore(tr, body.firstChild);
    else body.appendChild(tr);

    tr.appendChild(tdWhen); tr.appendChild(tdCode); tr.appendChild(tdState); tr.appendChild(tdDetail);
  }

  // --- Carga de listado.txt (autom√°tica y por archivo)
  async function loadListadoTxtAuto(){
    try {
      const res = await fetch("listado.txt", { cache: "no-store" });
      if (!res.ok) throw new Error("No se pudo cargar listado.txt");
      const text = await res.text();
      parseTxt(text);
      setStatus("ok", `Listado cargado autom√°ticamente (${whitelist.size} c√≥digos).`);
      updateResumen();
    } catch (e) {
      setStatus("warn", "No se pudo cargar autom√°ticamente listado.txt. Puedes subirlo manualmente.");
    }
  }

  function parseTxt(text){
    whitelist = new Set();
    text.split(/\r?\n/).forEach(line=>{
      const code = normalize(line);
      if (code) whitelist.add(code);
    });
  }

  // --- Escaneo y verificaci√≥n
  async function startScan(){
    if (scanning) return;
    const camId = el("cameraSelect").value;
    if (!camId) { setStatus("warn", "Selecciona una c√°mara antes de iniciar."); return; }
    if (!window.Html5Qrcode) { setStatus("bad", "No carg√≥ la librer√≠a de QR. Revisa tu conexi√≥n."); return; }

    html5Qr = new Html5Qrcode("reader");
    const config = { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 };
    try {
      await html5Qr.start(
        { deviceId: { exact: camId } },
        config,
        onScanSuccess,
        onScanError
      );
      scanning = true;
      setStatus("muted", "Escaneando‚Ä¶ apunta el QR al recuadro.");
    } catch (err) {
      setStatus("bad", "No se pudo iniciar la c√°mara: " + err);
      scanning = false;
    }
  }

  async function stopScan(){
    if (html5Qr && scanning) {
      try { await html5Qr.stop(); } catch {}
      try { await html5Qr.clear(); } catch {}
    }
    scanning = false;
    setStatus("muted", "Escaneo detenido.");
  }

  function onScanSuccess(decodedText){
    const code = normalize(decodedText);
    if (!code) return;

    const whenIso = nowIso();
    const firstPassIso = passes[code]; // undefined si nunca pas√≥

    if (!whitelist.size) {
      setStatus("warn", "A√∫n no cargas el listado. Carga listado.txt o s√∫belo manualmente.");
      appendLog({ whenIso, code, state: "warn", detail: "Listado no cargado" });
      return;
    }

    if (!whitelist.has(code)) {
      setStatus("bad", "‚ùå C√≥digo NO existe en el listado. Revise bien.");
      appendLog({ whenIso, code, state: "bad", detail: "No autorizado" });
      return;
    }

    if (!firstPassIso) {
      passes[code] = whenIso;
      savePasses();
      setStatus("ok", `‚úÖ OK, puede pasar. Hora: ${formatTime(whenIso)}`);
      appendLog({ whenIso, code, state: "ok", detail: "Primera pasada" });
      updateResumen();
    } else {
      setStatus("warn", `üü° Ya pas√≥ a las ${formatTime(firstPassIso)}; reintento a las ${formatTime(whenIso)}.`);
      appendLog({ whenIso, code, state: "warn", detail: `Primera: ${formatTime(firstPassIso)}` });
    }
  }

  function onScanError(_err){ /* ignoramos lecturas fallidas para no spamear */ }

  // --- Poblado de c√°maras
  async function fillCameras(){
    const sel = el("cameraSelect");
    sel.innerHTML = "";
    if (!navigator.mediaDevices?.enumerateDevices) {
      const opt = document.createElement("option");
      opt.value = ""; opt.textContent = "C√°maras no disponibles";
      sel.appendChild(opt);
      return;
    }
    const devices = await navigator.mediaDevices.enumerateDevices();
    const cams = devices.filter(d => d.kind === "videoinput");
    // Heur√≠stica: c√°mara trasera al inicio si se detecta
    cams.sort((a,b)=>{
      const la = (a.label||"").toLowerCase();
      const lb = (b.label||"").toLowerCase();
      const ra = /back|trase|rear/.test(la) ? -1 : 0;
      const rb = /back|trase|rear/.test(lb) ? -1 : 0;
      return ra - rb;
    });

    for (const c of cams) {
      const opt = document.createElement("option");
      opt.value = c.deviceId;
      opt.textContent = c.label || `C√°mara ${sel.length+1}`;
      sel.appendChild(opt);
    }
    if (!cams.length) {
      const opt = document.createElement("option");
      opt.value = ""; opt.textContent = "No hay c√°maras disponibles";
      sel.appendChild(opt);
    }
  }

  // --- Exportar historial a CSV
  function exportCsv(){
    const rows = [["Hora","C√≥digo","Estado","Detalle"]];
    const body = el("logBody");
    for (const tr of Array.from(body.children).reverse()) {
      const cols = Array.from(tr.children).map(td=>td.textContent);
      rows.push(cols);
    }
    const csv = rows.map(r => r.map(v => `"${(v||"").replace(/"/g,'""')}"`).join(",")).join("\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = `historial_${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 2000);
  }

  // --- Eventos UI
  el("btnStart").addEventListener("click", startScan);
  el("btnStop").addEventListener("click", stopScan);
  el("btnRecargar").addEventListener("click", loadListadoTxtAuto);
  el("btnExport").addEventListener("click", exportCsv);
  el("btnReset").addEventListener("click", ()=>{
    if (confirm("¬øSeguro que quieres reiniciar el registro de 'ya pas√≥'?")) {
      passes = {};
      savePasses();
      updateResumen();
      setStatus("muted", "Registro reiniciado. A partir de ahora, todos contar√°n como primera pasada.");
    }
  });

  el("fileTxt").addEventListener("change", async (ev)=>{
    const file = ev.target.files?.[0];
    if (!file) return;
    const text = await file.text();
    parseTxt(text);
    setStatus("ok", `Listado cargado manualmente (${whitelist.size} c√≥digos).`);
    updateResumen();
  });

  // --- Inicializaci√≥n
  (async function init(){
    updateResumen();
    await fillCameras();
    await loadListadoTxtAuto(); // intenta leer listado.txt de la misma carpeta
  })();

})();
</script>
</body>
</html>
